With our upgraded meterpreter shell, we can now try to escalate privileges. The main technique used here is that of [token impersonation](https://docs.microsoft.com/en-us/windows/win32/secauthz/access-tokens). Start by using ``shell powershell`` within our meterpreter shell. Running ``whoami /priv`` gives us a list of privileges and their states:

<center>

![8c6e13bcd9ca329caaf95caf839ca559.png](../../_resources/8c6e13bcd9ca329caaf95caf839ca559-1.png)

</center>

Note that a few privileges are enabled. Exit out to meterpreter and use the incognito module, then use ``list_tokens -g`` to list all available delegation and impersonation tokens.

<center>

![d7e82c70ea426de69a6169973870ebb6.png](../../_resources/d7e82c70ea426de69a6169973870ebb6-1.png)

</center>

Since the BUILTIN\Administrators token is available, we can impersonate it:

<center>

![7f63634cce1c105e8dcc5fe64050eb8a.png](../../_resources/7f63634cce1c105e8dcc5fe64050eb8a-1.png)

</center>

Using ``getuid`` confirms that we have successfully impersonated the above user, which answers the third question of Task 3. Next, we want to migrate to a process with the correct permissions. Using ``ps`` gives us some possibilities:

<center>

![87307fc3f9141c3f191b71b29ed05ae4.png](../../_resources/87307fc3f9141c3f191b71b29ed05ae4-1.png)

</center>

Migrate to the services.exe process using `migrate 668`. This gives us the correct permissions. We can now `cd` into the config directory and `cat root.txt` to get the final flag. Alternatively, we can drop into a shell and `type root.txt`.

<center>

![8cc2de1e9c169473bb79a83fc6ca9c81.png](../../_resources/8cc2de1e9c169473bb79a83fc6ca9c81-1.png)

</center>